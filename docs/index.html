<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Toplu & Tekli Satış Fiyatı Hesaplama | FIRAT KARAGÜLLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --primary:#0d6efd; --primary-hover:#0b5ed7; --border:#e5e7eb;
      --success:#16a34a; --danger:#dc2626; --table-head:#0d6efd; --table-head-text:#fff;
      --shadow:0 10px 30px rgba(0,0,0,.06); --radius:14px; --overlay: rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); }
    .wrap{max-width:1400px; margin:auto; padding:24px;}
    .title{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;}
    .title h1{font-size:22px; margin:0; letter-spacing:.2px}
    .badge{font-size:12px; color:#fff; background:var(--primary); padding:6px 10px; border-radius:999px;}

    .layout{ display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width:1100px){ .layout{grid-template-columns: 1fr;} }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }

    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:14px; border-bottom:1px solid var(--border); }
    .toolbar .spacer{flex:1}
    .btn{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; border:none; padding:10px 14px; border-radius:10px; font-weight:600; background:var(--primary); color:#fff; transition:all .15s ease; }
    .btn:hover{background:var(--primary-hover); transform:translateY(-1px)}
    .btn.secondary{background:#111827;} .btn.secondary:hover{background:#0b1220}
    .btn.ghost{ background:#eef2ff; color:#1e3a8a; } .btn.ghost:hover{background:#e0e7ff}
    .btn.link{ background:transparent; color:var(--primary); padding:4px 8px; }

    .file{ display:flex; align-items:center; gap:10px; padding:0 14px 14px 14px; }
    .file input[type="file"]{ padding:10px; border:1px dashed var(--border); border-radius:10px; background:#fafafa; }
    .file .filename{font-size:12px; color:var(--muted)}
    .status{ margin:10px 14px 0; font-size:13px; color:var(--muted); }

    .table-wrap{ margin-top:14px; border-top:1px solid var(--border); overflow:auto; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius); }
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:1100px;}
    thead th{ position:sticky; top:0; z-index:1; background:var(--table-head); color:var(--table-head-text); font-weight:700; text-align:center; padding:12px 10px; font-size:13px; }
    tbody td{padding:10px; text-align:center; border-bottom:1px solid var(--border); font-size:13px;}
    tbody tr:nth-child(odd){background:#fafafa}
    tbody tr:hover{background:#f1f5f9}

    .single-card{ padding:16px; }
    .single-card h2{ font-size:18px; margin:0 0 12px 0; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid-1{ display:grid; grid-template-columns: 1fr; gap:10px; }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px;}
    input[type="number"], input[type="text"]{ width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px; }
    .single-actions{ display:flex; gap:8px; margin-top:4px; }

    .inline{display:flex; align-items:center; gap:8px}

    .pill{ margin-top:10px; background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:14px; }
    .pill .lbl{ color:var(--muted); font-size:12px; }
    .kv{ display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:8px; background:#fff; border:1px solid var(--border); }

    input.manualPrice { width: 120px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; text-align: right; }
    .muted{ color:var(--muted); font-size:12px; }

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:var(--overlay);
      z-index: 9999;               /* tablo thead (sticky) üstüne çıkar */
    }
    .modal.active{ display:flex; }

    .modal .box{
      width:min(900px,95vw);
      background:#fff; border-radius:14px; box-shadow:var(--shadow); border:1px solid var(--border);
      max-height:85vh;              /* ekranı taşırma */
      display:flex; flex-direction:column;
    }
    .box .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px; border-bottom:1px solid var(--border);
    }
    .box .head h3{ margin:0; font-size:16px; }

    /* içerik kendi içinde scroll olsun, dışarı taşmasın */
    .box .content{ padding:14px; overflow:auto; }
    .rows{
      display:grid; gap:8px;
      max-height:320px;            /* gerektiğinde artırabilirsin */
      overflow-y:auto; padding-right:4px;
    }
    .rows > div{
      display:grid; grid-template-columns: 1fr 1fr 1fr auto;
      gap:8px; align-items:center;
    }
     body.modal-open{ overflow: hidden; }
    .rows input{ padding:8px; }
    .chip{ display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>Toplu & Tekli Satış Fiyatı Hesaplama</h1>
      <span class="badge">FIRAT KARAGÜLLE</span>
    </div>

    <div class="layout">
      <!-- SOL: TEKLİ HESAPLAMA -->
      <div class="card single-card">
        <h2>Tekli Ürün Hesaplama</h2>
        <div class="grid-2">
          <div><label>Maliyet (USD)</label><input type="text" id="s_cost_usd" placeholder="örn. 10,5"></div>
          <div><label>Maliyet (TL)</label><input type="text" id="s_cost_tl" placeholder="USD boşsa kullanılır"></div>
          <div><label>Döviz Kur (USD→TL)</label><input type="text" id="s_exchange_rate" value="39"></div>

          <div>
            <label>Kargo (TL) <span class="muted">(manuel; boşsa barem/desi)</span></label>
            <div class="inline">
              <input type="text" id="s_shipping_cost" placeholder="Boş bırak → barem">
              <input type="text" id="s_desi" placeholder="Desi" title="300 TL ve üzeri fiyatlarda desi gerekir">
              <button class="btn link" id="openBarem">⚙️</button>
            </div>
          </div>

          <div><label>Komisyon (%)</label><input type="text" id="s_commission_rate" value="21,5"></div>
          <div><label>KDV (%) <span class="muted">(boşsa 0)</span></label><input type="text" id="s_tax_rate" placeholder="örn. 0"></div>
          <div><label>Kar Oranı (%)</label><input type="text" id="s_profit_margin" value="35"></div>
          <div><label>Manuel Satış Fiyatı (TL)</label><input type="text" id="s_manual_price" placeholder="örn. 500"></div>
        </div>

        <div class="single-actions">
          <button class="btn" id="singleCalcBtn">Hesapla</button>
          <button class="btn ghost" id="singleClearBtn">Temizle</button>
        </div>

        <!-- ÖNERİLEN fiyat sonuçları -->
        <div class="pill" id="singleResult" style="display:none">
          <div class="kv"><div><div class="lbl">Önerilen Satış Fiyatı</div><div id="s_price" style="font-weight:700;"></div></div></div>
          <div class="kv"><div><div class="lbl">Elinize Geçecek Tutar</div><div id="s_net" style="font-weight:700;"></div></div></div>
          <div class="kv"><div><div class="lbl">Komisyon Tutarı</div><div id="s_comm"></div></div></div>
          <div class="kv"><div><div class="lbl">KDV Tutarı</div><div id="s_tax"></div></div></div>
          <div class="kv"><div><div class="lbl">KDV Hariç Fiyat</div><div id="s_ex"></div></div></div>
          <div class="kv"><div><div class="lbl">Stopaj Tutarı</div><div id="s_stp"></div></div></div>
        </div>

        <!-- MANUEL fiyat sonuçları (dinamik) -->
        <div class="pill" id="singleManual" style="display:none">
          <div class="kv"><div><div class="lbl">Manuel Satış Fiyatı</div><div id="sm_price" style="font-weight:700;"></div></div></div>
          <div class="kv"><div><div class="lbl">Kar (%)</div><div id="sm_kar" style="font-weight:700;"></div></div></div>
          <div class="kv"><div><div class="lbl">Net Gelir (TL)</div><div id="sm_net"></div></div></div>
          <div class="kv"><div><div class="lbl">Komisyon Tutarı</div><div id="sm_comm"></div></div></div>
          <div class="kv"><div><div class="lbl">KDV Tutarı</div><div id="sm_tax"></div></div></div>
          <div class="kv"><div><div class="lbl">KDV Hariç Fiyat</div><div id="sm_ex"></div></div></div>
          <div class="kv"><div><div class="lbl">Stopaj Tutarı</div><div id="sm_stp"></div></div></div>
        </div>
      </div>

      <!-- SAĞ: TOPLU HESAPLAMA -->
      <div class="card">
        <div class="toolbar">
          <button class="btn ghost" id="downloadTemplateBtn">📥 Şablonu İndir</button>
          <button class="btn ghost" id="openBarem2">⚙️ Kargo Barem</button>
          <div class="spacer"></div>
          <button class="btn" id="calcBtn">Hesapla</button>
          <button class="btn secondary" id="exportBtn">📤 Sonuçları İndir</button>
        </div>

        <div class="file">
          <input type="file" id="excelFile" accept=".xlsx,.csv" />
          <div class="filename" id="fileName">Henüz dosya seçilmedi</div>
        </div>

        <div class="status" id="status"></div>

        <div class="table-wrap">
          <table id="resultsTable" aria-label="Hesaplama Sonuçları">
            <thead>
              <tr>
                <th>#</th><th>Barkod</th><th>USD</th><th>TL</th><th>Kur</th><th>Desi</th>
                <th>Komisyon (%)</th><th>KDV (%)</th><th>Kar (%)</th><th>Fiyat (TL)</th>
                <th>Kargo (TL)</th>
                <th>Net Gelir (TL)</th><th>Komisyon Tutarı</th><th>KDV Tutarı</th>
                <th>KDV Hariç Fiyat</th><th>Stopaj Tutarı</th><th>Manuel Satış Fiyatı Gir</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div> <!-- /layout -->
  </div>

  <!-- BAREM MODAL -->
  <div class="modal" id="baremModal" aria-hidden="true">
    <div class="box">
      <div class="head">
        <h3>⚙️ Kargo Barem Ayarları</h3>
        <div>
          <button class="btn ghost" id="resetBarem">⟲ Varsayılan</button>
          <button class="btn" id="saveBarem">Kaydet</button>
          <button class="btn secondary" id="closeBarem">Kapat</button>
        </div>
      </div>
      <div class="content">
        <p class="muted">Kural: <span class="chip">0 – 149.99 TL → <b id="lblU150"></b></span> <span class="chip">150 – 299.99 TL → <b id="lblU300"></b></span> <span class="chip">≥ 300 TL → <b>DESİ TABLOSU</b></span></p>
        <div class="grid-2">
          <div>
            <label>0 – 149.99 TL kargo (TL)</label>
            <input type="text" id="u150" placeholder="örn. 44,5" />
          </div>
          <div>
            <label>150 – 299.99 TL kargo (TL)</label>
            <input type="text" id="u300" placeholder="örn. 74,5" />
          </div>
        </div>
        <hr style="margin:14px 0;border:0;border-top:1px solid var(--border)"/>
        <p class="muted">DESİ tablosu: satır ekleyin veya toplu Excel/CSV yükleyin; sistem desi değeri bu aralıkların hangisine düşüyorsa o kargo bedelini uygular.</p>
        <div class="rows" id="desiRows"></div>
        <div style="margin-top:8px; display:flex; gap:8px">
          <button class="btn" id="addRow">+ Satır Ekle</button>
          <input type="file" id="desiFile" accept=".xlsx,.csv" style="display:none"/>
          <button class="btn ghost" id="bulkUpload">📥 Toplu Desi Fiyatları Yükle</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Number utils (virgül & nokta dayanıklı) ----------
    function parseLocaleNumber(sRaw){
      if (sRaw===null||sRaw===undefined) return 0;
      let s = String(sRaw).trim();
      if (!s) return 0;
      s = s.replace(/\s/g,''); // boşlukları temizle

      const hasDot = s.includes('.');
      const hasComma = s.includes(',');

      // Hem nokta hem virgül varsa: son görülen karakter ondalıktır, diğeri binliktir
      if (hasDot && hasComma) {
        const lastDot = s.lastIndexOf('.');
        const lastComma = s.lastIndexOf(',');
        const dec = (lastComma > lastDot) ? ',' : '.';
        const thou = dec === ',' ? '.' : ',';
        s = s.split(thou).join('');         // tüm binlikleri kaldır
        if (dec === ',') s = s.replace(',', '.'); // ondalığı noktaya çevir
        return parseFloat(s);
      }

      // Sadece virgül: ondalık gibi davran
      if (hasComma) return parseFloat(s.replace(',', '.'));

      // Sadece nokta: birden çok nokta varsa binlikleri kaldır
      if (hasDot) {
        const parts = s.split('.');
        if (parts.length > 2) {
          const last = parts.pop();
          s = parts.join('') + (last ? '.' + last : '');
        }
        return parseFloat(s);
      }
      // Sadece rakam
      return parseFloat(s);
    }
    const toNumber = parseLocaleNumber;
    const fmtTL = (n)=> new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n||0));
    const fmtPct =(n)=> new Intl.NumberFormat('tr-TR',{minimumFractionDigits:0, maximumFractionDigits:2}).format(Number(n||0));
    const clampPct = v => Math.max(0, Math.min(100, toNumber(v)));
    const STOPAJ_RATE = 0.01;

    function applyKarColor(el, karVal){ if(!el) return; el.style.color = (Number(karVal) < 0) ? 'var(--danger)' : 'var(--success)'; el.style.fontWeight='700'; }
    function denomOrThrow(commissionRate, taxRate){
      const taxInternalRate = taxRate / (1 + taxRate);
      const denom = 1 - commissionRate - taxInternalRate - (STOPAJ_RATE / (1 + taxRate));
      if (denom <= 0.000001) throw new Error("Kesinti oranları toplamı çok yüksek; fiyat hesaplanamıyor.");
      return {denom, taxInternalRate};
    }

    // ---------- Barem config (localStorage) ----------
    const BAREM_STORAGE_KEY = "kargo_barem_cfg_v1";
    const defaultBarem = { under150: 44.5, under300: 74.5, desiTable: [] };
    function loadBarem(){ try{ const raw=localStorage.getItem(BAREM_STORAGE_KEY); return raw? JSON.parse(raw): structuredClone(defaultBarem);}catch(e){ return structuredClone(defaultBarem);} }
    function saveBarem(cfg){ localStorage.setItem(BAREM_STORAGE_KEY, JSON.stringify(cfg)); }

    function shippingByBarem(price, desi){
      const cfg = loadBarem();
      if (price < 150) return toNumber(cfg.under150);
      if (price < 300) return toNumber(cfg.under300);
      const d = toNumber(desi);
      const row = (cfg.desiTable || []).find(r => d >= toNumber(r.min) && d <= toNumber(r.max));
      return row ? toNumber(row.price) : 0;
    }

    // Fiyat bilinmiyorken baremle iteratif çözüm
    function computeGivenShipping({ cost_usd, cost_tl, exchange_rate, shipping_cost, commission_rate_percent, tax_rate_percent_raw, profit_margin_percent }){
      const costUsd = toNumber(cost_usd);
      const costTl  = toNumber(cost_tl);
      const exchangeRate = toNumber(exchange_rate);
      const shippingCost = toNumber(shipping_cost);
      const commissionRate = clampPct(commission_rate_percent)/100;
      const taxRate = (tax_rate_percent_raw===""||tax_rate_percent_raw==null) ? 0 : clampPct(tax_rate_percent_raw)/100;
      const profitMargin = clampPct(profit_margin_percent)/100;

      const baseCost = costUsd > 0 ? costUsd * exchangeRate : costTl;
      const targetNet = baseCost * (1 + profitMargin);
      const {denom, taxInternalRate} = denomOrThrow(commissionRate, taxRate);
      const finalPrice = (targetNet + shippingCost) / denom;

      const commissionAmount   = finalPrice * commissionRate;
      const taxAmount          = finalPrice * taxInternalRate;
      const priceExcludingTax  = finalPrice / (1 + taxRate);
      const stopajAmount       = priceExcludingTax * STOPAJ_RATE;
      const netIncome          = finalPrice - commissionAmount - taxAmount - stopajAmount - shippingCost;

      return { finalPrice, netIncome, commissionAmount, taxAmount, priceExcludingTax, stopajAmount, baseCost, shippingCost, taxRate, commissionRate };
    }
    function computeWithBarem({ cost_usd, cost_tl, exchange_rate, commission_rate_percent, tax_rate_percent_raw, profit_margin_percent, desi }){
      let guessPrice = 100;
      let shipping = shippingByBarem(guessPrice, desi);
      let lastTier=-1;
      for (let i=0;i<12;i++){
        const out = computeGivenShipping({ cost_usd, cost_tl, exchange_rate, shipping_cost: shipping, commission_rate_percent, tax_rate_percent_raw, profit_margin_percent });
        const tier = out.finalPrice < 150 ? 1 : (out.finalPrice < 300 ? 2 : 3);
        const newShipping = shippingByBarem(out.finalPrice, desi);
        if (Math.abs(newShipping - shipping) < 0.001 && tier===lastTier) return { ...out, shippingCost: newShipping };
        lastTier = tier; shipping = newShipping; guessPrice = out.finalPrice;
      }
      return computeGivenShipping({ cost_usd, cost_tl, exchange_rate, shipping_cost: shipping, commission_rate_percent, tax_rate_percent_raw, profit_margin_percent });
    }

    // ---------- Şablon (Desi sütunlu) ----------
    function downloadTemplate(){
      const headers = ["Barkod","USD","TL","Kur","Desi","Komisyon (%)","KDV (%)","Kar (%)"];
      const ws = XLSX.utils.aoa_to_sheet([headers, ["", "", "", "39", "", "21,5", "", "35"]]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Veri");
      XLSX.writeFile(wb, "toplu_satis_sablonu_desi.xlsx");
    }

    // ---------- UI refs ----------
    let exportData = [];
    const fileInput  = document.getElementById('excelFile');
    const fileNameEl = document.getElementById('fileName');
    const statusEl   = document.getElementById('status');
    const setStatus = (msg)=> statusEl.innerHTML = msg;

    document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
    fileInput.addEventListener('change', ()=>{ fileNameEl.textContent = fileInput.files?.[0]?.name ?? "Henüz dosya seçilmedi"; });

    // ---- Tekli hesapla ----
    document.getElementById('singleCalcBtn').addEventListener('click', ()=>{
      try{
        const usd=document.getElementById('s_cost_usd').value;
        const tl=document.getElementById('s_cost_tl').value;
        const kur=document.getElementById('s_exchange_rate').value;
        const kom=document.getElementById('s_commission_rate').value;
        const kdv=document.getElementById('s_tax_rate').value;
        const kar=document.getElementById('s_profit_margin').value;
        const manualShip=document.getElementById('s_shipping_cost').value;
        const desi=document.getElementById('s_desi').value;

        const out = (String(manualShip).trim()!=="")
          ? computeGivenShipping({ cost_usd:usd, cost_tl:tl, exchange_rate:kur, shipping_cost:manualShip, commission_rate_percent:kom, tax_rate_percent_raw:kdv, profit_margin_percent:kar })
          : computeWithBarem({ cost_usd:usd, cost_tl:tl, exchange_rate:kur, commission_rate_percent:kom, tax_rate_percent_raw:kdv, profit_margin_percent:kar, desi });

        document.getElementById('singleResult').style.display = 'grid';
        document.getElementById('s_price').textContent = fmtTL(out.finalPrice);
        document.getElementById('s_net').textContent   = fmtTL(out.netIncome);
        document.getElementById('s_comm').textContent  = fmtTL(out.commissionAmount);
        document.getElementById('s_tax').textContent   = fmtTL(out.taxAmount);
        document.getElementById('s_ex').textContent    = fmtTL(out.priceExcludingTax);
        document.getElementById('s_stp').textContent   = fmtTL(out.stopajAmount);

        updateSingleManual();
      }catch(err){ alert(err.message || String(err)); }
    });

    // ---- Tekli temizle ----
    document.getElementById('singleClearBtn').addEventListener('click', ()=>{
      ['s_cost_usd','s_cost_tl','s_tax_rate','s_manual_price','s_shipping_cost','s_desi'].forEach(id=> document.getElementById(id).value = '');
      document.getElementById('s_exchange_rate').value = '39';
      document.getElementById('s_commission_rate').value = '21,5';
      document.getElementById('s_profit_margin').value = '35';
      document.getElementById('singleResult').style.display = 'none';
      document.getElementById('singleManual').style.display = 'none';
    });

    // ---- Tekli: Manuel fiyat dinamik ----
    document.getElementById('s_manual_price').addEventListener('input', updateSingleManual);
    ['s_cost_usd','s_cost_tl','s_exchange_rate','s_shipping_cost','s_commission_rate','s_tax_rate','s_desi'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ if (document.getElementById('s_manual_price').value.trim()!=="") updateSingleManual(); });
    });

    function updateSingleManual(){
      const manualVal = document.getElementById('s_manual_price').value;
      const costUsd = document.getElementById('s_cost_usd').value;
      const costTl  = document.getElementById('s_cost_tl').value;
      const kur     = document.getElementById('s_exchange_rate').value;
      let kargo     = document.getElementById('s_shipping_cost').value;
      const kom     = document.getElementById('s_commission_rate').value;
      const kdvRaw  = document.getElementById('s_tax_rate').value;
      const desi    = document.getElementById('s_desi').value;

      const baseCost = (toNumber(costUsd) > 0) ? toNumber(costUsd) * toNumber(kur) : toNumber(costTl);
      if (String(manualVal).trim()===""){ document.getElementById('singleManual').style.display = 'none'; return; }

      if (String(kargo).trim()===""){ const priceGuess = toNumber(manualVal); kargo = shippingByBarem(priceGuess, desi); }

      const taxRate = (kdvRaw === "" || kdvRaw == null) ? 0 : (clampPct(kdvRaw)/100);
      const commissionRate = clampPct(kom)/100;
      const finalPrice = toNumber(manualVal);
      const {taxInternalRate} = denomOrThrow(commissionRate, taxRate);

      const commissionAmount = finalPrice * commissionRate;
      const taxAmount = finalPrice * taxInternalRate;
      const priceExcludingTax = finalPrice / (1 + taxRate);
      const stopajAmount = priceExcludingTax * STOPAJ_RATE;
      const netIncome = finalPrice - commissionAmount - taxAmount - stopajAmount - toNumber(kargo);

      const karPct = baseCost > 0 ? ((netIncome - baseCost) / baseCost) * 100 : 0;

      document.getElementById('singleManual').style.display = 'grid';
      document.getElementById('sm_price').textContent = fmtTL(finalPrice);
      document.getElementById('sm_net').textContent   = fmtTL(netIncome);
      document.getElementById('sm_comm').textContent  = fmtTL(commissionAmount);
      document.getElementById('sm_tax').textContent   = fmtTL(taxAmount);
      document.getElementById('sm_ex').textContent    = fmtTL(priceExcludingTax);
      document.getElementById('sm_stp').textContent   = fmtTL(stopajAmount);
      const karEl = document.getElementById('sm_kar');
      karEl.textContent = fmtPct(karPct) + "%";
      applyKarColor(karEl, karPct);
    }

    // ---- TOPLU: Tek satır manuel fiyat ile ----
    function recalcRow(idx, manualPriceVal){
      const row = exportData[idx];
      const taxRate = toNumber(row["KDV (%)"]) / 100;
      const commissionRate = toNumber(row["Komisyon (%)"]) / 100;
      const usd = toNumber(row.USD);
      const tl  = toNumber(row.TL);
      const kur = toNumber(row.Kur);
      const desi = toNumber(row.Desi);
      const baseCost = usd > 0 ? usd * kur : tl;

      let finalPrice, commissionAmount, taxAmount, priceExTax, stopajAmount, netIncome, newKarPct, usedShipping;
      if (manualPriceVal !== null && manualPriceVal !== undefined && String(manualPriceVal).trim() !== ""){
        finalPrice = toNumber(manualPriceVal);
        usedShipping = shippingByBarem(finalPrice, desi);
        const taxInternalRate = taxRate / (1 + taxRate);
        commissionAmount = finalPrice * commissionRate;
        taxAmount        = finalPrice * taxInternalRate;
        priceExTax       = finalPrice / (1 + taxRate);
        stopajAmount     = priceExTax * STOPAJ_RATE;
        netIncome        = finalPrice - commissionAmount - taxAmount - stopajAmount - usedShipping;
        newKarPct = baseCost > 0 ? ((netIncome - baseCost) / baseCost) * 100 : 0;
        row["Manuel Fiyat (TL)"] = Number(finalPrice.toFixed(2));
        row["Kar (%)"] = Number(newKarPct.toFixed(2));
      } else {
        const out = computeWithBarem({
          cost_usd: usd, cost_tl: tl, exchange_rate: kur,
          commission_rate_percent: row["Komisyon (%)"], tax_rate_percent_raw: row["KDV (%)"], profit_margin_percent: row.__origKar, desi
        });
        finalPrice     = out.finalPrice;
        commissionAmount = out.commissionAmount;
        taxAmount        = out.taxAmount;
        priceExTax       = out.priceExcludingTax;
        stopajAmount     = out.stopajAmount;
        netIncome        = out.netIncome;
        usedShipping     = out.shippingCost;
        row["Manuel Fiyat (TL)"] = "";
        row["Kar (%)"] = row.__origKar;
      }

      row["Fiyat (TL)"]         = Number(finalPrice.toFixed(2));
      row["Kargo (TL)"]         = Number((usedShipping ?? shippingByBarem(finalPrice, desi)).toFixed(2));
      row["Net Gelir (TL)"]     = Number(netIncome.toFixed(2));
      row["Komisyon Tutarı"]    = Number(commissionAmount.toFixed(2));
      row["KDV Tutarı"]         = Number(taxAmount.toFixed(2));
      row["KDV Hariç Fiyat"]    = Number(priceExTax.toFixed(2));
      row["Stopaj Tutarı"]      = Number(stopajAmount.toFixed(2));

      document.getElementById(`price-${idx}`).textContent   = fmtTL(row["Fiyat (TL)"]);
      document.getElementById(`ship-${idx}`).textContent    = fmtTL(row["Kargo (TL)"]);
      document.getElementById(`net-${idx}`).textContent     = fmtTL(row["Net Gelir (TL)"]);
      document.getElementById(`kom-${idx}`).textContent     = fmtTL(row["Komisyon Tutarı"]);
      document.getElementById(`kdvamt-${idx}`).textContent  = fmtTL(row["KDV Tutarı"]);
      document.getElementById(`ex-${idx}`).textContent      = fmtTL(row["KDV Hariç Fiyat"]);
      document.getElementById(`stp-${idx}`).textContent     = fmtTL(row["Stopaj Tutarı"]);

      const karEl = document.getElementById(`kar-${idx}`);
      karEl.textContent = fmtPct(row["Kar (%)"]) + "%";
      applyKarColor(karEl, row["Kar (%)"]);
    }

    // ---- TOPLU: Dosyayı oku ve tabloyu üret ----
    document.getElementById('calcBtn').addEventListener('click', handleFile);
    document.getElementById('exportBtn').addEventListener('click', exportResults);

    function handleFile() {
      const file = fileInput.files?.[0];
      if (!file) { alert("Lütfen bir Excel/CSV dosyası seçin."); return; }

      setStatus("Hesaplanıyor…");
      const reader = new FileReader();
      reader.onload = function (e) {
        try{
          let rows=[];
          if (file.name.toLowerCase().endsWith('.csv')){
            const text = new TextDecoder('utf-8').decode(e.target.result);
            const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
            const headers=lines.shift().split(',');
            rows = lines.map(line=>{
              const parts=line.split(',');
              const obj={}; headers.forEach((h,i)=>obj[h.trim()]=parts[i]??""); return obj;
            });
          } else {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          }

          const required = ["Barkod","USD","TL","Kur","Desi","Komisyon (%)","KDV (%)","Kar (%)"];
          const missing = required.filter(k=> !(k in (rows[0]||{})) );
          if (missing.length){ throw new Error("Eksik başlık(lar): " + missing.join(', ') + "\nLütfen şablonu kullanın."); }

          const tbody = document.querySelector('#resultsTable tbody');
          tbody.innerHTML = '';
          exportData = [];

          rows.forEach((row, index) => {
            const barkod = row.Barkod || '';
            const usd  = toNumber(row.USD);
            const tl   = toNumber(row.TL);
            const kur  = toNumber(row.Kur);
            const desi = toNumber(row.Desi);
            const komisyon = toNumber(row["Komisyon (%)"]);
            const kdvRaw = (row["KDV (%)"] === undefined || row["KDV (%)"] === null || String(row["KDV (%)"]).trim()==="") ? "" : row["KDV (%)"];
            const kar  = toNumber(row["Kar (%)"]);

            const out = computeWithBarem({
              cost_usd: usd, cost_tl: tl, exchange_rate: kur,
              commission_rate_percent: komisyon, tax_rate_percent_raw: kdvRaw, profit_margin_percent: kar, desi
            });

            const shownKdv = (kdvRaw === "" || kdvRaw === undefined ? 0 : toNumber(kdvRaw));
            const usedShipping = shippingByBarem(out.finalPrice, desi);

            const resRow = {
              Barkod: barkod, USD: usd || '', TL: tl || '', Kur: kur || '', Desi: desi || '',
              "Komisyon (%)": komisyon, "KDV (%)": shownKdv,
              __origKar: kar, "Kar (%)": kar,
              "Fiyat (TL)": Number(out.finalPrice.toFixed(2)),
              "Kargo (TL)": Number(usedShipping.toFixed(2)),
              "Net Gelir (TL)": Number(out.netIncome.toFixed(2)),
              "Komisyon Tutarı": Number(out.commissionAmount.toFixed(2)),
              "KDV Tutarı": Number(out.taxAmount.toFixed(2)),
              "KDV Hariç Fiyat": Number(out.priceExcludingTax.toFixed(2)),
              "Stopaj Tutarı": Number(out.stopajAmount.toFixed(2)),
              "Manuel Fiyat (TL)": ""
            };
            exportData.push(resRow);

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${barkod}</td>
              <td>${usd ? fmtTL(usd) : '-'}</td>
              <td>${tl ? fmtTL(tl) : '-'}</td>
              <td>${kur ? fmtTL(kur) : '-'}</td>
              <td>${desi ? fmtTL(desi) : '-'}</td>
              <td>${fmtPct(komisyon)}%</td>
              <td>${fmtPct(shownKdv)}%</td>
              <td id="kar-${index}">${fmtPct(kar)}%</td>
              <td id="price-${index}"><b>${fmtTL(resRow["Fiyat (TL)"])}</b></td>
              <td id="ship-${index}">${fmtTL(resRow["Kargo (TL)"])}</td>
              <td id="net-${index}">${fmtTL(resRow["Net Gelir (TL)"])}</td>
              <td id="kom-${index}">${fmtTL(resRow["Komisyon Tutarı"])}</td>
              <td id="kdvamt-${index}">${fmtTL(resRow["KDV Tutarı"])}</td>
              <td id="ex-${index}">${fmtTL(resRow["KDV Hariç Fiyat"])}</td>
              <td id="stp-${index}">${fmtTL(resRow["Stopaj Tutarı"])}</td>
              <td><input type="text" class="manualPrice" data-index="${index}" placeholder="örn. 500" /></td>
            `;
            tbody.appendChild(tr);

            applyKarColor(document.getElementById(`kar-${index}`), kar);
          });

          document.querySelectorAll('.manualPrice').forEach(inp=>{
            inp.addEventListener('input', (e)=>{
              const idx = e.target.dataset.index;
              const val = e.target.value;
              recalcRow(idx, val);
            });
          });

          const cfg=loadBarem();
          setStatus(`Hesaplama tamamlandı: ${exportData.length} satır. Barem: <b>0-149.99</b> → ${fmtTL(cfg.under150)} TL, <b>150-299.99</b> → ${fmtTL(cfg.under300)} TL, ≥300 TL → DESİ tablosu.`);
        }catch(err){
          setStatus(`<span style="color:var(--danger)">Hata: ${err.message || String(err)}</span>`);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ---- TOPLU: dışa aktar ----
    function exportResults() {
      if (exportData.length === 0) { alert("Hesaplanmış veri yok!"); return; }
      const clean = exportData.map(({__origKar, ...rest})=>rest);
      const ws = XLSX.utils.json_to_sheet(clean);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sonuclar");
      XLSX.writeFile(wb, "hesaplanan_satis_fiyatlari.xlsx");
    }

    // ---------- Barem Modal UI ----------
    const modal = document.getElementById('baremModal');
    const openBtns=[document.getElementById('openBarem'), document.getElementById('openBarem2')];
    const closeBtn=document.getElementById('closeBarem');
    const saveBtn=document.getElementById('saveBarem');
    const resetBtn=document.getElementById('resetBarem');
    const u150=document.getElementById('u150');
    const u300=document.getElementById('u300');
    const lblU150=document.getElementById('lblU150');
    const lblU300=document.getElementById('lblU300');
    const rowsEl=document.getElementById('desiRows');
    const addRowBtn=document.getElementById('addRow');
    const bulkBtn=document.getElementById('bulkUpload');
    const desiFile=document.getElementById('desiFile');

    function makeRow(idx, r){
      const div=document.createElement('div');
      div.innerHTML = `
        <input type="text" class="min" placeholder="Min desi" value="${r.min??''}"/>
        <input type="text" class="max" placeholder="Max desi" value="${r.max??''}"/>
        <input type="text" class="price" placeholder="Kargo TL" value="${r.price??''}"/>
        <button class="btn secondary del">Sil</button>
      `;
      div.querySelector('.del').addEventListener('click', ()=>{ div.remove(); });
      return div;
    }
    function renderBarem(){
      const cfg=loadBarem();
      u150.value = String(cfg.under150).replace('.', ',');
      u300.value = String(cfg.under300).replace('.', ',');
      lblU150.textContent = fmtTL(cfg.under150) + ' TL';
      lblU300.textContent = fmtTL(cfg.under300) + ' TL';
      rowsEl.innerHTML='';
      (cfg.desiTable||[]).forEach((r,idx)=> rowsEl.appendChild(makeRow(idx, r)) );
    }
    function openModal(){
      modal.classList.add('active'); renderBarem();
      document.body.classList.add('modal-open');
    }
    function closeModal(){
      modal.classList.remove('active');
      document.body.classList.remove('modal-open');
    }

    openBtns.forEach(b=> b && b.addEventListener('click', openModal));
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

    addRowBtn.addEventListener('click', ()=>{ rowsEl.appendChild(makeRow(Date.now(), {min:"",max:"",price:""})); });

    resetBtn.addEventListener('click', ()=>{ saveBarem(defaultBarem); renderBarem(); alert('Varsayılanlara döndü.'); });

    saveBtn.addEventListener('click', ()=>{
      const cfg={ under150: toNumber(u150.value), under300: toNumber(u300.value), desiTable: [] };
      rowsEl.querySelectorAll(':scope > div').forEach(div=>{
        const min=toNumber(div.querySelector('.min').value);
        const max=toNumber(div.querySelector('.max').value);
        const price=toNumber(div.querySelector('.price').value);
        if (!isNaN(min) && !isNaN(max) && !isNaN(price) && (max>=min)) cfg.desiTable.push({min, max, price});
      });
      cfg.desiTable.sort((a,b)=> a.min-b.min);
      saveBarem(cfg);
      renderBarem();
      alert('Kargo baremi kaydedildi. Yeni hesaplamalarda kullanılacak.');
    });

    // Toplu Desi Fiyatları Yükle
    bulkBtn.addEventListener('click', ()=> desiFile.click());
    desiFile.addEventListener('change', ()=>{
      const file=desiFile.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=(e)=>{
        try{
          let rows=[];
          if (file.name.toLowerCase().endsWith('.csv')){
            const text=new TextDecoder('utf-8').decode(e.target.result);
            const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
            const headers=lines.shift().split(',');
            rows=lines.map(line=>{
              const parts=line.split(',');
              const obj={}; headers.forEach((h,i)=>obj[h.trim()]=parts[i]??""); return obj;
            });
          } else {
            const data=new Uint8Array(e.target.result);
            const wb=XLSX.read(data,{type:'array'});
            const sheet=wb.Sheets[wb.SheetNames[0]];
            rows=XLSX.utils.sheet_to_json(sheet,{defval:""});
          }
          const parsed=rows.map(r=>({min:toNumber(r["Min Desi"]), max:toNumber(r["Max Desi"]), price:toNumber(r["Kargo TL"])}))
                           .filter(r=>!isNaN(r.min)&&!isNaN(r.max)&&!isNaN(r.price));
          if (!parsed.length) throw new Error("Dosyada uygun veri bulunamadı. Başlıklar: Min Desi, Max Desi, Kargo TL");
          const cfg=loadBarem(); cfg.desiTable=parsed.sort((a,b)=>a.min-b.min); saveBarem(cfg);
          renderBarem(); alert(parsed.length+" satır eklendi.");
        }catch(err){ alert("Hata: "+(err.message||String(err))); }
      };
      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
